name: Windows VNC + noVNC + Cloudflared (Persistent)

on:
  workflow_dispatch:

jobs:
  vnc-novnc:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Python 3
        run: choco install python -y

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install websockify

      - name: Download TigerVNC installer
        run: |
          Invoke-WebRequest -Uri "https://cytranet-dal.dl.sourceforge.net/project/tigervnc/stable/1.15.0/tigervnc-1.15.0.exe?viasf=1" -OutFile C:\tigervnc-1.15.0.exe

      - name: Install TigerVNC silently
        run: |
          Start-Process -FilePath "C:\tigervnc-1.15.0.exe" -ArgumentList "/S" -Wait

      - name: Download noVNC
        run: |
          if (-Not (Test-Path "C:\novnc")) {
            git clone https://github.com/novnc/noVNC.git C:\novnc
          }

      - name: Download Cloudflared
        run: |
          Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile C:\cloudflared.exe

      - name: Create VNC password
        run: |
          New-Item -ItemType Directory -Force -Path C:\temp
          echo "mypassword" > C:\temp\plainpass.txt
          & "C:\Program Files\TigerVNC\vncpasswd.exe" -f < "C:\temp\plainpass.txt" > C:\vncpasswd.txt

      - name: Start VNC server
        run: |
          Start-Process -FilePath "C:\Program Files\TigerVNC\vncserver.exe" -ArgumentList ":1 -PasswordFile C:\vncpasswd.txt" -NoNewWindow

      - name: Start noVNC
        run: |
          cd C:\novnc
          Start-Process -FilePath "python" -ArgumentList "-m websockify --web . 6080 localhost:5901" -NoNewWindow

      - name: Start Cloudflared tunnel
        run: |
          Start-Process -FilePath "C:\cloudflared.exe" -ArgumentList "tunnel --url http://localhost:6080" -NoNewWindow

      - name: Keep workflow alive (like tail -f /dev/null)
        run: |
          Write-Host "Runner will stay alive for 1 hour to keep VNC/noVNC accessible..."
          $end = (Get-Date).AddHours(1)
          while ((Get-Date) -lt $end) {
            Start-Sleep -Seconds 10
          }
